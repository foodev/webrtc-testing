<!doctype html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
</head>

<button style="padding: 0 20px; font-size: 40px;">call</button>
<button style="padding: 0 20px; font-size: 40px;">end call</button>
<br>
<video style="float: left; width: 720px; max-width: 100%;"></video>
<video style="float: left; width: 300px; max-width: 50%;" muted></video>

<script>
var nodejsServer = /* ip/url of the nodejs server */;

// websocket
var socket = new WebSocket('ws://' + nodejsServer, 'videochat');

// videochat
var call = document.getElementsByTagName('button')[0], endCall = document.getElementsByTagName('button')[1],
    videoFriend = document.getElementsByTagName('video')[0], videoOwn = document.getElementsByTagName('video')[1];

var offererConnection, answererConnection;

var peerConfig = null;

navigator.webkitGetUserMedia({
    audio: true,
    video: true
}, function(stream) {
    window.userMedia = stream;
}, function(error) {});

socket.onmessage = function(e) {
    var data = JSON.parse(e.data);

    // you are the answerer
    if (!offererConnection) {
        // sdp offer
        if (data.type == 'offer') {
            console.debug('answerer: friend is calling');
            call.disabled = true;

            //if (confirm('Accept incoming call ?')) {
                //navigator.webkitGetUserMedia({
                //    audio: true,
                //    video: true
                //}, function(stream) {
                    console.debug('answerer: got own stream: ', window.userMedia);
                    videoOwn.src = URL.createObjectURL(window.userMedia);
                    videoOwn.play();

                    answererConnection = new webkitRTCPeerConnection(peerConfig);

                    answererConnection.onaddstream = function(stream) {
                        console.debug('answerer: added stream of friend: ', stream);

                        videoFriend.src = URL.createObjectURL(stream.stream);
                        videoFriend.play();
                    };

                    answererConnection.addStream(window.userMedia);

                    answererConnection.onicecandidate = function (e) {
                        if (e.candidate) {
                            console.debug('answerer: got ice candidate: ', e.candidate);
                            console.debug('answerer: sent ice candidate: ', e.candidate);
                            socket.send(JSON.stringify(e.candidate));
                        }
                    };

                    // sdp offer
                    answererConnection.setRemoteDescription(new RTCSessionDescription(data), function() {
                        answererConnection.createAnswer(function(answer) {
                            answererConnection.setLocalDescription(answer);

                            console.debug('answerer: accept call from friend: ', answer);
                            socket.send(JSON.stringify(answer));
                        });
                    });
                //}, function(e) {});
            //}
        }

        // ice candidate
        if (data.candidate) {
            answererConnection.addIceCandidate(new RTCIceCandidate(data));
            console.debug('answerer: added ice candidate: ', data);
        }
    }

    // you are the offerer
    else {
        // sdp answer
        if (data.type == 'answer') {
            console.debug('offerer: got answer from friend: ', data);
            offererConnection.setRemoteDescription(new RTCSessionDescription(data));
        }

        // ice candidate
        if (data.candidate) {
            offererConnection.addIceCandidate(new RTCIceCandidate(data));
            console.debug('offerer: added ice candidate: ', data);
        }
    }
};

call.onclick = function() {
    //navigator.webkitGetUserMedia({
    //    audio: true,
    //    video: true
    //}, function(stream) {
        call.disabled = true;

        console.debug('offerer: got own stream: ', window.userMedia);
        videoOwn.src = URL.createObjectURL(window.userMedia);
        videoOwn.play();

        offererConnection = new webkitRTCPeerConnection(peerConfig);

        offererConnection.onaddstream = function(stream) {
            console.debug('offerer: added stream of friend: ', stream);

            videoFriend.src = URL.createObjectURL(stream.stream);
            videoFriend.play();
        };

        offererConnection.addStream(window.userMedia);

        offererConnection.createDataChannel('RTCDataChannel', {
            reliable: false
        });

        offererConnection.onicecandidate = function (e) {
            if (e.candidate) {
                console.debug('offerer: got ice candidate: ', e.candidate);
                console.debug('offerer: sent ice candidate: ', e.candidate);
                socket.send(JSON.stringify(e.candidate));
            }
        };

        // send an offer to your friend
        offererConnection.createOffer(function(offer) {
            offererConnection.setLocalDescription(new RTCSessionDescription(offer), function() {
                console.debug('offerer: trying to call friend: ', offer);
                socket.send(JSON.stringify(offer));
            });
        });
    //}, function(e) {});
};

endCall.onclick= function() {
    var connection = offererConnection || answererConnection;

    connection.removeStream(window.userMedia);
    connection.close();

    call.disabled = false;

    console.debug('call ended');
};
</script>
